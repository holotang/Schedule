<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>東京フィル トロンボーンセクション スケジュール</title>
    <style>
        :root { --main: #1a1a1a; --bg: #f2f2f7; --accent: #d4af37; --calendar-blue: #1a73e8; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; color: #1c1c1e; }
        
        header { background: #fff; padding: 8px 12px; position: sticky; top: 0; z-index: 100; box-shadow: 0 1px 10px rgba(0,0,0,0.1); }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        h1 { margin: 0; font-size: 0.85rem; color: #1c1c1e; font-weight: bold; }
        .current-month-display { font-size: 1.1rem; font-weight: 900; color: var(--main); }

        .month-nav { display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 8px; background: #f2f2f7; padding: 4px; border-radius: 8px; }
        .nav-btn { background: none; border: none; font-size: 1rem; cursor: pointer; padding: 4px 10px; border-radius: 6px; font-weight: bold; }

        .filter-bar { display: flex; gap: 4px; padding-bottom: 2px; justify-content: space-between; }
        .filter-btn { flex: 1; padding: 6px 0; border-radius: 8px; font-size: 0.75rem; font-weight: 900; border: 1px solid #d1d1d6; background: white; color: #8e8e93; text-align: center; }
        .filter-btn.active { border-color: var(--main); background: var(--main); color: white; }

        .container { max-width: 600px; margin: 0 auto; padding: 8px; }
        .day-row { background: white; border-radius: 14px; margin-bottom: 10px; display: flex; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); min-height: 90px; scroll-margin-top: 140px; }
        .day-row.is-today { outline: 2px solid var(--accent); background: #fffdf5; }
        
        .date-side { width: 50px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #f9f9fb; border-right: 1px solid #e5e5ea; flex-shrink: 0; }
        .date-num { font-size: 1.2rem; font-weight: 800; }
        .date-day { font-size: 0.6rem; font-weight: bold; }
        .sun { color: #ff3b30; } .sat { color: #007aff; }

        .task-side { flex: 1; padding: 10px 12px; display: flex; flex-direction: column; justify-content: center; gap: 6px; }
        .task-item { border-bottom: 1px solid #f2f2f7; padding-bottom: 10px; cursor: pointer; }
        .task-item:last-child { border: none; }
        
        .role-label { font-size: 0.5rem; font-weight: 900; padding: 1px 3px; border-radius: 2px; }
        .role-1st-bg { background: #00ffff; }
        .role-2nd-bg { background: #ff00ff; }
        .role-Bass-bg { background: #ffff00; }
        .role-Ex-bg { background: #e5e5ea; }

        .mem-tag { font-size: 0.65rem; padding: 2px 6px; border-radius: 5px; color: white; font-weight: bold; }
        .mem-辻󠄀 { background: #ff3b30; } .mem-中西 { background: #007aff; } .mem-五箇 { background: #34c759; } 
        .mem-山内 { background: #ff9500; } .mem-藤田 { background: #af52de; } .mem-石川 { background: #5856d6; }
        .mem-Ex1, .mem-Ex2 { background: #8e8e93; }

        .cat-tag { font-size: 0.55rem; padding: 1px 5px; border-radius: 3px; color: white; font-weight: bold; margin-right: 3px; }
        .cat-リハ { background: #8e8e93; } .cat-GP { background: #d4af37; } .cat-本番 { background: #000; }

        .task-title { font-size: 0.95rem; font-weight: bold; line-height: 1.3; }
        .task-time-row { font-size: 0.8rem; font-weight: bold; color: #3a3a3c; display: flex; align-items: center; margin-top: 4px; }
        .task-loc { font-size: 0.75rem; color: #8e8e93; }

        /* 操作ボタン */
        .fab-group { position: fixed; bottom: 25px; right: 20px; display: flex; flex-direction: column; gap: 15px; z-index: 200; }
        .fab { width: 55px; height: 55px; border-radius: 50%; border: none; font-size: 24px; color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.3); cursor: pointer; }
        .fab-add { background: var(--main); }
        .fab-sync { background: var(--calendar-blue); font-size: 20px; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 300; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: white; width: 90%; max-width: 400px; padding: 20px; border-radius: 20px; max-height: 85vh; overflow-y: auto; }
        
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: none; align-items: center; justify-content: center; z-index: 1000; font-weight: bold; }
    </style>
</head>
<body>

<div id="loading" class="loading-overlay">同期中...</div>

<header>
    <div class="header-top">
        <h1>東京フィル トロンボーンセクション スケジュール</h1>
        <div class="current-month-display" id="head-month"></div>
    </div>
    <div class="month-nav">
        <button class="nav-btn" onclick="changeMonth(-1)">◀</button>
        <button class="nav-btn" onclick="goToday()">今日</button>
        <button class="nav-btn" onclick="changeMonth(1)">▶</button>
    </div>
</header>

<div class="container" id="calendar-container"></div>

<div class="fab-group">
    <button class="fab fab-sync" onclick="syncAllFutureToGoogle()" title="今日以降のすべての予定を同期">⚡️</button>
    <button class="fab fab-add" onclick="openModal()">＋</button>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzNv8hxvtL6kt2s4D65XmHYXnHvJbll7KQIoDa8CFtcfno-wj959MERsbiRQkQ7rj42iw/exec"; 
    let allTasks = [];
    let viewDate = new Date(); viewDate.setDate(1);

    async function loadData() {
        showLoading(true);
        try {
            const res = await fetch(`${GAS_URL}?t=${new Date().getTime()}`);
            const raw = await res.json();
            allTasks = raw ? raw.map(t => ({ 
                d: String(t[0]), t: String(t[1]), reheS: String(t[2] || ""), reheE: String(t[3] || ""),
                loc: String(t[4]), mems: String(t[5]).split(','), id: String(t[6]),
                gpS: String(t[7] || ""), gpE: String(t[8] || ""), perfS: String(t[9] || ""), perfE: String(t[10] || "")
            })) : [];
            render();
        } catch (e) { console.error(e); }
        showLoading(false);
    }

    // 今日以降の全予定を一括同期
    function syncAllFutureToGoogle() {
        const now = new Date();
        const todayStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
        
        const futureTasks = allTasks.filter(t => t.d >= todayStr).sort((a,b) => a.d.localeCompare(b.d));
        
        if (futureTasks.length === 0) {
            alert("同期する今後の予定がありません。");
            return;
        }

        if (confirm(`${futureTasks.length} 件の予定を Google カレンダーに登録します。\n1件ずつ登録画面が開きます。よろしいですか？`)) {
            futureTasks.forEach((t, index) => {
                // ブラウザのポップアップブロックを避けるため、少し時間をずらして開く
                setTimeout(() => {
                    const url = generateCalLink(t);
                    window.open(url, '_blank');
                }, index * 800); 
            });
        }
    }

    function generateCalLink(t) {
        const dateNoDash = t.d.replace(/-/g, '');
        let startTime = "090000", endTime = "120000";
        const times = [];
        if(t.reheS && t.reheS !== "none") times.push({s:t.reheS, e:t.reheE});
        if(t.gpS && t.gpS !== "none") times.push({s:t.gpS, e:t.gpE});
        if(t.perfS && t.perfS !== "none") times.push({s:t.perfS, e:t.perfE});

        if(times.length > 0) {
            times.sort((a,b) => a.s.localeCompare(b.s));
            startTime = times[0].s.replace(':','') + "00";
            endTime = times[times.length-1].e.replace(':','') + "00";
        }
        const details = `奏者: ${t.mems.join(', ')}\n場所: ${t.loc}`;
        return `https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(t.t)}&dates=${dateNoDash}T${startTime}/${dateNoDash}T${endTime}&details=${encodeURIComponent(details)}&location=${encodeURIComponent(t.loc)}&sf=true&output=xml`;
    }

    // --- その他、描画や保存の関数（前回と同様） ---
    function render() {
        const y = viewDate.getFullYear(); const m = viewDate.getMonth() + 1;
        document.getElementById('head-month').innerText = `${y}年 ${m}月`;
        const lastDay = new Date(y, m, 0).getDate();
        let html = '';
        for(let d=1; d<=lastDay; d++) {
            const dateStr = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const dayTasks = allTasks.filter(t => t.d.includes(dateStr));
            // ... (描画処理) ...
        }
        document.getElementById('calendar-container').innerHTML = html;
    }

    function showLoading(show) { document.getElementById('loading').style.display = show ? 'flex' : 'none'; }
    window.onload = loadData;
</script>
</body>
</html>
